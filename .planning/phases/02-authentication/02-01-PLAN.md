---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dashboard/middleware.ts
  - dashboard/components/layout/header.tsx
  - dashboard/components/auth/sign-out-button.tsx
  - dashboard/.env.example
autonomous: true

must_haves:
  truths:
    - "All dashboard routes (/settings, /tasks, /metrics) are protected by authentication"
    - "Sign-out redirects to /auth/signin (not /login)"
    - "Sign-in button links to /auth/signin (not /login)"
    - "GitHub OAuth env vars in .env.example match lib/auth.ts (GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET)"
  artifacts:
    - path: "dashboard/middleware.ts"
      provides: "Route protection for all dashboard routes"
      contains: "/settings"
    - path: "dashboard/components/layout/header.tsx"
      provides: "Consistent auth callback URLs"
      contains: "/auth/signin"
    - path: "dashboard/components/auth/sign-out-button.tsx"
      provides: "Correct sign-out callback URL"
      contains: "/auth/signin"
  key_links:
    - from: "dashboard/middleware.ts"
      to: "dashboard/app/auth/signin/page.tsx"
      via: "redirect URL"
      pattern: "/auth/signin"
---

<objective>
Fix authentication gaps in the existing NextAuth v5 implementation.

Purpose: The authentication system is already implemented but has three specific gaps that need addressing: incomplete route protection, inconsistent callback URLs, and missing environment variable documentation.

Output: All dashboard routes properly protected, consistent `/auth/signin` callback URLs throughout the codebase, and documented GitHub OAuth environment variables.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@dashboard/middleware.ts
@dashboard/lib/auth.ts
@dashboard/app/auth/signin/page.tsx
@dashboard/components/layout/header.tsx
@dashboard/components/auth/sign-out-button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update middleware to protect all dashboard routes</name>
  <files>dashboard/middleware.ts</files>
  <action>
Update the middleware to protect additional dashboard routes that are currently unprotected.

Current state - only these routes are protected:
```ts
const protectedRoutes = ["/agents", "/projects"];
```

Updated state - add these routes:
```ts
const protectedRoutes = ["/agents", "/projects", "/settings", "/tasks", "/metrics"];
```

Also update the matcher configuration to include these routes:
```ts
export const config = {
  matcher: [
    // Protected routes
    "/agents/:path*",
    "/projects/:path*",
    "/settings/:path*",
    "/tasks/:path*",
    "/metrics/:path*",
    // Auth pages
    "/auth/:path*",
    // API auth routes (to allow through)
    "/api/auth/:path*",
  ],
};
```

Why: These routes contain dashboard functionality that should only be accessible to authenticated users. The middleware already has proper redirect logic to `/auth/signin` - we just need to include more routes.
  </action>
  <verify>
Review middleware.ts to confirm:
- protectedRoutes array includes all 5 routes
- matcher array includes all 5 route patterns
  </verify>
  <done>All dashboard routes are protected by authentication middleware</done>
</task>

<task type="auto">
  <name>Task 2: Fix inconsistent callback URLs in header component</name>
  <files>dashboard/components/layout/header.tsx</files>
  <action>
Fix two incorrect callback URLs in the header component that reference `/login` instead of `/auth/signin`.

Location 1 - Line 58, handleSignOut function:
```ts
// Current (incorrect)
signOut({ callbackUrl: "/login" })

// Updated (correct)
signOut({ callbackUrl: "/auth/signin" })
```

Location 2 - Line 173, Sign In button link:
```tsx
// Current (incorrect)
<Link href="/login">Sign In</Link>

// Updated (correct)
<Link href="/auth/signin">Sign In</Link>
```

Why: The sign-in page is located at `/auth/signin` (as configured in `lib/auth.ts` and implemented in `app/auth/signin/page.tsx`). Using `/login` would result in a 404 error since that route doesn't exist.
  </action>
  <verify>
Search for "/login" in header.tsx - should return no results
Search for "/auth/signin" in header.tsx - should return 2 results
  </verify>
  <done>Header component uses consistent /auth/signin callback URLs</done>
</task>

<task type="auto">
  <name>Task 3: Fix callback URL in sign-out-button component</name>
  <files>dashboard/components/auth/sign-out-button.tsx</files>
  <action>
Fix the incorrect callback URL in the sign-out button component.

Location - Line 15, handleSignOut function:
```ts
// Current (incorrect)
signOut({ callbackUrl: "/login" });

// Updated (correct)
signOut({ callbackUrl: "/auth/signin" });
```

Why: Consistency with the sign-in page location. After signing out, users should be redirected to the actual sign-in page.
  </action>
  <verify>
Search for "/login" in sign-out-button.tsx - should return no results
Search for "/auth/signin" in sign-out-button.tsx - should return 1 result
  </verify>
  <done>Sign-out button uses correct /auth/signin callback URL</done>
</task>

<task type="auto">
  <name>Task 4: Fix GitHub OAuth env var names in .env.example</name>
  <files>dashboard/.env.example</files>
  <action>
Fix the GitHub OAuth environment variable names in .env.example to match what lib/auth.ts expects.

**Current state (lines 23-24 in .env.example):**
```
GITHUB_ID=your-github-client-id
GITHUB_SECRET=your-github-client-secret
```

**Required state (matching lib/auth.ts lines 28-29):**
```
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret
```

Why: lib/auth.ts reads `process.env.GITHUB_CLIENT_ID` and `process.env.GITHUB_CLIENT_SECRET`. Using GITHUB_ID/GITHUB_SECRET will cause GitHub OAuth to silently fail because the credentials won't be found.
  </action>
  <verify>
grep "GITHUB_CLIENT_ID" dashboard/.env.example - should return a match
grep "GITHUB_CLIENT_SECRET" dashboard/.env.example - should return a match
grep "GITHUB_ID=" dashboard/.env.example - should return no matches (renamed)
  </verify>
  <done>GitHub OAuth env vars in .env.example match lib/auth.ts variable names</done>
</task>

</tasks>

<verification>
Phase 2 Plan 01 is complete when:
1. `grep "/settings" dashboard/middleware.ts` returns a match
2. `grep "/tasks" dashboard/middleware.ts` returns a match
3. `grep "/metrics" dashboard/middleware.ts` returns a match
4. `grep "/login" dashboard/components/` returns no matches
5. `grep "/auth/signin" dashboard/components/layout/header.tsx` returns 2 matches
6. `grep "/auth/signin" dashboard/components/auth/sign-out-button.tsx` returns 1 match
7. `grep "GITHUB_CLIENT_ID" dashboard/.env.example` returns a match
8. `grep "GITHUB_CLIENT_SECRET" dashboard/.env.example` returns a match
</verification>

<success_criteria>
- All dashboard routes (/agents, /projects, /settings, /tasks, /metrics) redirect to /auth/signin when unauthenticated
- Sign-out from any component redirects to /auth/signin
- Sign-in button links to /auth/signin
- No references to non-existent /login route remain in components
- GitHub OAuth credentials are documented with correct variable names
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md` documenting:
- Routes added to middleware protection
- Files updated with corrected callback URLs
- Environment variable verification results
</output>
